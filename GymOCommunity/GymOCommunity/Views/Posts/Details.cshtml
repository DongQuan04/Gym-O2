@model GymOCommunity.Models.Post

<h2>Chi tiết bài viết</h2>

<p><strong>Tiêu đề:</strong> @Model.Title</p>
<p><strong>Nội dung:</strong></p>
<p>@Model.Content</p>
<p><strong>Ngày tạo:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy")</p>

@if (!string.IsNullOrEmpty(Model.ImageUrl))
{
    <p><strong>Ảnh bài viết:</strong></p>
    <img src="@Model.ImageUrl" alt="Ảnh bài viết" class="grid-image" onclick="openImageModal(this.src)" />
}

@if ((Model.PostImages != null && Model.PostImages.Any()) || !string.IsNullOrEmpty(Model.VideoUrl))
{
    <p><strong>Xem thêm:</strong></p>
    <div class="image-grid">
        @if (Model.PostImages != null && Model.PostImages.Any())
        {
            foreach (var img in Model.PostImages)
            {
                <img src="@img.ImageUrl" alt="Ảnh phụ" class="grid-image" onclick="openImageModal(this.src)" />
            }
        }

        @if (!string.IsNullOrEmpty(Model.VideoUrl))
        {
            <video class="grid-image" onclick="openVideoModal('@Model.VideoUrl')">
                <source src="@Model.VideoUrl" type="video/mp4" />
                Trình duyệt không hỗ trợ phát video.
            </video>
        }
    </div>
}

@if (Model.PostVideos != null && Model.PostVideos.Any())
{
    <h4 class="mt-4">Video</h4>
    <div class="video-grid">
        @foreach (var video in Model.PostVideos)
        {
            <video class="grid-image mt-2 mb-2" onclick="openVideoModal('@video.VideoUrl')">
                <source src="@video.VideoUrl" type="video/mp4" />
                Trình duyệt không hỗ trợ phát video.
            </video>
        }
    </div>
}

<!-- Modal xem ảnh -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:9999;">
    <span onclick="closeImageModal()" style="position:absolute; top:10px; right:20px; color:white; font-size:30px; cursor:pointer;">&times;</span>
    <span id="prevBtn" onclick="showPrevImage()" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); font-size:40px; color:white; cursor:pointer;">&#10094;</span>
    <span id="nextBtn" onclick="showNextImage()" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); font-size:40px; color:white; cursor:pointer;">&#10095;</span>
    <img id="modalImage" style="max-width:90%; max-height:90%;" />
</div>
<script>
    let currentImageIndex = 0;
    let imageList = [];

    function openImageModal(src) {
        // Tìm tất cả ảnh trong grid
        imageList = Array.from(document.querySelectorAll(".grid-image")).filter(img => img.tagName.toLowerCase() === "img");
        currentImageIndex = imageList.findIndex(img => img.src === src);

        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').style.display = 'flex';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    function showNextImage() {
        if (imageList.length === 0) return;
        currentImageIndex = (currentImageIndex + 1) % imageList.length;
        document.getElementById('modalImage').src = imageList[currentImageIndex].src;
    }

    function showPrevImage() {
        if (imageList.length === 0) return;
        currentImageIndex = (currentImageIndex - 1 + imageList.length) % imageList.length;
        document.getElementById('modalImage').src = imageList[currentImageIndex].src;
    }

    document.addEventListener("DOMContentLoaded", function () {
        window.scrollTo(0, document.body.scrollHeight);
    });
</script>


<!-- Modal xem video -->
<div id="videoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:9999;">
    <span onclick="closeVideoModal()" style="position:absolute; top:10px; right:20px; color:white; font-size:30px; cursor:pointer;">&times;</span>
    <video id="modalVideo" controls style="max-width:90%; max-height:90%; border-radius:8px;"></video>
</div>

<hr />

<h3>Bình luận</h3>
@if (Model.Comments != null && Model.Comments.Any())
{
    <ul class="list-group">
        @foreach (var comment in Model.Comments)
        {
            <li class="list-group-item">
                <strong>@comment.UserName:</strong> @comment.Content<br />
                <small class="text-muted">@comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
            </li>
        }
    </ul>
}
else
{
    <p>Chưa có bình luận nào.</p>
}

<form asp-action="AddComment" method="post">
    <input type="hidden" name="PostId" value="@Model.Id" />
    <div class="form-group">
        <label for="commentContent">Thêm bình luận:</label>
        <textarea name="Content" class="form-control" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary mt-2">Gửi bình luận</button>
</form>

<hr />

<a href="/Posts/Edit/@Model.Id" class="btn btn-warning">Chỉnh sửa</a>
<a href="/Posts/Delete/@Model.Id" class="btn btn-danger">Xóa</a>
<a href="/Posts" class="btn btn-secondary">Quay lại</a>

@section Styles {
    <style>
        .image-grid, .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .grid-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 1px solid #ccc;
        }

            .grid-image:hover {
                transform: scale(1.03);
            }
    </style>
}

@section Scripts {
    <script>
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function openVideoModal(src) {
            const video = document.getElementById('modalVideo');
            video.src = src;
            video.play();
            document.getElementById('videoModal').style.display = 'flex';
        }

        function closeVideoModal() {
            const video = document.getElementById('modalVideo');
            video.pause();
            video.src = "";
            document.getElementById('videoModal').style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", function () {
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>
}
