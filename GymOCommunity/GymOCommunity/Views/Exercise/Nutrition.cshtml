@{
    ViewBag.Title = "Chế độ dinh dưỡng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 text-white">
    <h2 class="text-warning fw-bold mb-4">🧮 Tùy chỉnh Chế độ Dinh dưỡng</h2>
    <div class="row g-3">
        <div class="col-md-4"><input type="number" id="height" placeholder="Chiều cao (cm)" class="form-control" /></div>
        <div class="col-md-4"><input type="number" id="weight" placeholder="Cân nặng (kg)" class="form-control" /></div>
        <div class="col-md-4"><input type="number" id="age" placeholder="Tuổi" class="form-control" /></div>
        <div class="col-md-4">
            <select id="gender" class="form-select">
                <option value="Nam">Nam</option>
                <option value="Nữ">Nữ</option>
            </select>
        </div>
        <div class="col-md-4">
            <select id="goal" class="form-select">
                <option value="Tăng cơ">Tăng cơ</option>
                <option value="Giảm mỡ">Giảm mỡ</option>
                <option value="Giữ cân">Giữ cân</option>
            </select>
        </div>
        <div class="col-md-4"><input type="number" id="sessions" placeholder="Buổi tập/tuần" class="form-control" /></div>
        <div class="col-md-4">
            <select id="bodyType" class="form-select">
                <option value="Ectomorph">Ectomorph</option>
                <option value="Mesomorph">Mesomorph</option>
                <option value="Endomorph">Endomorph</option>
            </select>
        </div>
        <div class="col-md-12 text-center mt-3">
            <button onclick="generatePlan()" class="btn btn-warning text-dark fw-bold px-4">Xem Gợi ý Dinh dưỡng</button>
        </div>
    </div>

    <hr class="my-5">

    <div>
        <h3 class="text-warning mb-3">🥗 Gợi ý thực đơn</h3>
        <div class="row g-4" id="mealSuggestion">
            <div class="col-md-6"><div class="card bg-dark text-white p-3 rounded-4"><h5>🍳 Bữa sáng</h5><div id="breakfast"></div></div></div>
            <div class="col-md-6"><div class="card bg-dark text-white p-3 rounded-4"><h5>🍱 Bữa trưa</h5><div id="lunch"></div></div></div>
            <div class="col-md-6"><div class="card bg-dark text-white p-3 rounded-4"><h5>🍽️ Bữa tối</h5><div id="dinner"></div></div></div>
            <div class="col-md-6"><div class="card bg-dark text-white p-3 rounded-4"><h5>🥜 Snack</h5><div id="snack"></div></div></div>
        </div>
    </div>

    <div class="mt-5">
        <h3 class="text-warning mb-3">📊 Tổng kết dinh dưỡng</h3>
        <div class="card bg-dark text-white p-4 rounded-4">
            <p><strong>TDEE:</strong> <span id="tdeeValue">--</span> kcal/ngày</p>
            <p><strong>Protein:</strong> <span id="proteinValue">--</span></p>
            <p><strong>Carb:</strong> <span id="carbValue">--</span></p>
            <p><strong>Fat:</strong> <span id="fatValue">--</span></p>
        </div>
        <div class="text-end mt-3">
            <button onclick="exportToExcel()" class="btn btn-success">
                📤 Xuất Excel
            </button>
        </div>

    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
                const mealPlans = {
                    "Nam": {
                        "Tăng cơ": {
                            breakfast: ["🍚 Cơm + Trứng – 2 quả", "🥛 Sữa tươi – 250ml", "🍌 Chuối – 1 quả"],
                            lunch: ["🍗 Ức gà – 150g", "🍚 Cơm gạo lứt – 100g", "🥗 Salad rau – 100g"],
                            dinner: ["🥩 Bò xào nấm – 150g", "🥔 Khoai lang – 100g", "🥦 Bông cải – 100g"],
                            snack: ["🥜 Hạnh nhân – 30g", "🥤 Whey – 1 muỗng"]
                        },
                        "Giảm mỡ": {
                            breakfast: ["🥚 Trứng luộc – 2 quả", "🥒 Dưa leo – 100g", "☕ Cà phê đen – 1 ly"],
                            lunch: ["🐟 Cá hấp – 150g", "🥬 Rau cải – 100g", "🍠 Khoai lang – 80g"],
                            dinner: ["🍗 Ức gà – 100g", "🥣 Súp rau củ – 1 chén", "🍄 Nấm luộc – 50g"],
                            snack: ["🥜 Hạt điều – 20g", "🍎 Táo – 1 quả"]
                        },
                        "Giữ cân": {
                            breakfast: ["🍞 Bánh mì đen – 2 lát", "🥚 Trứng ốp – 1 quả", "🥣 Sữa chua Hy Lạp – 100g"],
                            lunch: ["🍚 Cơm trắng – 100g", "🥩 Thịt nạc – 100g", "🥬 Canh rau cải – 1 chén"],
                            dinner: ["🍗 Ức gà nướng – 100g", "🍠 Khoai lang – 80g", "🥗 Salad trộn – 100g"],
                            snack: ["🍌 Chuối – 1 quả", "🥛 Sữa chua – 100g"]
                        }
                    },
                    "Nữ": {
                        "Tăng cơ": {
                            breakfast: ["🍞 Bánh mì nguyên cám – 1 lát", "🥚 Trứng – 1 quả", "🍌 Chuối – 1 quả"],
                            lunch: ["🍗 Ức gà – 100g", "🍠 Khoai lang – 80g", "🥗 Salad rau – 100g"],
                            dinner: ["🥩 Thịt bò – 100g", "🥦 Bông cải – 100g", "🥣 Súp rau – 1 chén"],
                            snack: ["🥛 Sữa chua – 100g", "🥜 Hạt hạnh nhân – 15g"]
                        },
                        "Giảm mỡ": {
                            breakfast: ["🥚 Trứng luộc – 1 quả", "🥒 Dưa leo – 100g"],
                            lunch: ["🐟 Cá hấp – 100g", "🥬 Salad – 80g", "🍠 Khoai lang – 80g"],
                            dinner: ["🍗 Ức gà – 80g", "🍄 Nấm – 50g", "🥣 Súp lơ – 1 chén"],
                            snack: ["🍏 Táo – 1 quả", "🥜 Hạt điều – 10g"]
                        },
                        "Giữ cân": {
                            breakfast: ["🍞 Bánh mì đen – 1 lát", "🥚 Trứng – 1 quả", "🥣 Sữa chua – 100g"],
        lunch: ["🍚 Cơm trắng – 80g", "🥩 Thịt nạc – 80g", "🥬 Rau luộc – 100g"],
                            dinner: ["🍗 Ức gà – 100g", "🍠 Khoai lang – 80g", "🥗 Salad – 80g"],
                            snack: ["🍌 Chuối – 1 quả", "🥛 Sữa – 100ml"]
                        }
                    }
                };

                function renderMeal(mealId, items) {
                    const container = document.getElementById(mealId);
                    container.innerHTML = "<ul>" + items.map(i => `<li>${i}</li>`).join("") + "</ul>";
                }

                function generatePlan() {
                    const height = parseFloat(document.getElementById("height").value);
                    const weight = parseFloat(document.getElementById("weight").value);
                    const age = parseInt(document.getElementById("age").value);
                    const gender = document.getElementById("gender").value;
                    const goal = document.getElementById("goal").value;
                    const sessions = parseInt(document.getElementById("sessions").value);
                    const bodyType = document.getElementById("bodyType").value;

                    // BMR & TDEE
                    const BMR = (gender === "Nam")
                        ? 10 * weight + 6.25 * height - 5 * age + 5
                        : 10 * weight + 6.25 * height - 5 * age - 161;

                    const activityFactor = sessions <= 2 ? 1.3 : sessions <= 4 ? 1.55 : 1.75;
                    let TDEE = BMR * activityFactor;
                    if (goal === "Tăng cơ") TDEE += 300;
                    else if (goal === "Giảm mỡ") TDEE -= 300;

                    // Macro phân bổ
                    let proteinRatio = 0.3, carbRatio = 0.5, fatRatio = 0.2;
                    if (bodyType === "Ectomorph") {
                        carbRatio = 0.55; proteinRatio = 0.25;
                    } else if (bodyType === "Endomorph") {
                        carbRatio = 0.4; proteinRatio = 0.35; fatRatio = 0.25;
                    }

                    const proteinGrams = Math.round((TDEE * proteinRatio) / 4);
                    const carbGrams = Math.round((TDEE * carbRatio) / 4);
                    const fatGrams = Math.round((TDEE * fatRatio) / 9);

                    const plan = mealPlans[gender][goal];
                    renderMeal("breakfast", plan.breakfast);
                    renderMeal("lunch", plan.lunch);
                    renderMeal("dinner", plan.dinner);
                    renderMeal("snack", plan.snack);

                    document.getElementById("tdeeValue").innerText = Math.round(TDEE);
                    document.getElementById("proteinValue").innerText = proteinGrams + "g";
                    document.getElementById("carbValue").innerText = carbGrams + "g";
                    document.getElementById("fatValue").innerText = fatGrams + "g";
                }

                      function exportToExcel() {
                    const gender = document.getElementById("gender").value;
                    const goal = document.getElementById("goal").value;
                    const plan = mealPlans[gender][goal];

                    const extractItems = (mealName, items) =>
                        items.map(entry => {
        // Biểu tượng (emoji) là ký tự đầu tiên
                            const icon = entry.trim().substring(0, 2).match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g) ? entry.trim().substring(0, 2) : entry.trim().charAt(0);
                            const cleaned = entry.replace(icon, "").trim();
                            const [foodName, weight] = cleaned.split("–").map(s => s.trim());
                            return {
                                "Bữa": mealName,
                                "Biểu tượng": icon,
                                "Món ăn": foodName,
                                "Khối lượng": weight || ""
                            };
                        });

                    const rows = [
                        ...extractItems("Bữa sáng", plan.breakfast),
                        ...extractItems("Bữa trưa", plan.lunch),
                        ...extractItems("Bữa tối", plan.dinner),
                        ...extractItems("Snack", plan.snack),
                        {},
                        { "Bữa": "TDEE", "Khối lượng": document.getElementById("tdeeValue").innerText + " kcal" },
                        { "Bữa": "Protein", "Khối lượng": document.getElementById("proteinValue").innerText },
                        { "Bữa": "Carb", "Khối lượng": document.getElementById("carbValue").innerText },
                        { "Bữa": "Fat", "Khối lượng": document.getElementById("fatValue").innerText }
                    ];

                    const ws = XLSX.utils.json_to_sheet(rows, {
                        header: ["Bữa", "Biểu tượng", "Món ăn", "Khối lượng"]
                    });

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "DinhDuong");
                    const fileName = `DinhDuong_${gender}_${goal.replace(/\s/g, "")}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                }

    </script>
}






<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>⏰ HOẠT ĐỘNG CỘNG ĐỒNG</h3>
                <p>📅 Hoạt động 24/7 – Kết nối, chia sẻ, học hỏi mọi lúc, mọi nơi!</p>
            </div>

            <div class="footer-section">
                <h3>📍 KẾT NỐI VỚI CHÚNG TÔI</h3>
                <p><i class="fas fa-envelope"></i> info@GymO.com.vn</p>
                <p><i class="fas fa-phone"></i> 0967 355 455</p>
            </div>

            <div class="footer-section">
                <h3>📚 THÔNG TIN</h3>
                <p><a href="#">Tham gia đội ngũ Admin</a></p>
                <p><a href="#">Về chúng tôi</a></p>
                <p><a href="#">Điều khoản & Điều kiện</a></p>
                <p><a href="#">Chính sách bảo mật</a></p>
            </div>

            <div class="footer-social">
                <p>THEO DÕI CỘNG ĐỒNG</p>

                <!-- Link đến Facebook, Instagram, YouTube -->
                <div class="social-icons">
                    <a href="https://www.facebook.com/groups/1356980198758964" target="_blank">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://www.instagram.com/YOUR_INSTAGRAM" target="_blank">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://www.youtube.com/%40Gym-OCommunity" target="_blank" title="Kênh YouTube Gym-O Community">
                        <i class="fab fa-youtube"></i>
                    </a>

                </div>



                <!--nút Messenger và Điện thoại-->
                <div class="floating-buttons">
                    <a href="https://www.messenger.com/c/993659855635864/t/9356117234476365" target="_blank" class="messenger-btn">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Facebook_Messenger_logo_2020.svg/768px-Facebook_Messenger_logo_2020.svg.png" alt="Messenger">
                    </a>
                    <a href="tel:0967355455" class="phone-btn">
                        <img src="https://cdn0.iconfinder.com/data/icons/social-messaging-ui-color-shapes-3/3/54-1024.png" alt="Call">
                    </a>
                </div>



                <!-- Thêm widget Facebook -->
                <div class="fb-page" data-href="https://www.facebook.com/YOUR_PAGE"
                     data-tabs="" data-width="300" data-height="150" data-small-header="false"
                     data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true">
                </div>
            </div>


        </div>
    </div>
</footer>